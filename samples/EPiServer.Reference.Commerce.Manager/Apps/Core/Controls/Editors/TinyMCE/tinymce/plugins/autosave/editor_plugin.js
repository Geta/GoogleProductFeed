(function(d){var g="autosave",f="restoredraft",b=true,a,c,e=d.util.Dispatcher;d.create("tinymce.plugins.AutoSave",{init:function(l,h){var k=this,j=l.settings;k.editor=l;function i(n){var m={s:1000,m:60000};n=/^(\d+)([ms]?)$/.exec(""+n);return(n[2]?m[n[2]]:1)*parseInt(n);}d.each({ask_before_unload:b,interval:"30s",retention:"20m",minlength:50},function(n,m){m=g+"_"+m;if(j[m]===a){j[m]=n;}});j.autosave_interval=i(j.autosave_interval);j.autosave_retention=i(j.autosave_retention);l.addButton(f,{title:g+".restore_content",onclick:function(){if(l.getContent({draft:true}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0){l.windowManager.confirm(g+".warning_message",function(m){if(m){k.restoreDraft();}});}else{k.restoreDraft();}}});l.onNodeChange.add(function(){var m=l.controlManager;if(m.get(f)){m.setDisabled(f,!k.hasDraft());}});l.onInit.add(function(){if(l.controlManager.get(f)){k.setupStorage(l);setInterval(function(){k.storeDraft();l.nodeChanged();},j.autosave_interval);}});k.onStoreDraft=new e(k);k.onRestoreDraft=new e(k);k.onRemoveDraft=new e(k);if(!c){window.onbeforeunload=d.plugins.AutoSave._beforeUnloadHandler;c=b;}},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:d.majorVersion+"."+d.minorVersion};},getExpDate:function(){return new Date(new Date().getTime()+this.editor.settings.autosave_retention).toUTCString();},setupStorage:function(k){var j=this,i=g+"_test",h="OK";j.key=g+k.id;d.each([function(){if(localStorage){localStorage.setItem(i,h);if(localStorage.getItem(i)===h){localStorage.removeItem(i);return localStorage;}}},function(){if(sessionStorage){sessionStorage.setItem(i,h);if(sessionStorage.getItem(i)===h){sessionStorage.removeItem(i);return sessionStorage;}}},function(){if(d.isIE){k.getElement().style.behavior="url('#default#userData')";return{autoExpires:b,setItem:function(n,l){var m=k.getElement();m.setAttribute(n,l);m.expires=j.getExpDate();m.save("TinyMCE");},getItem:function(l){var m=k.getElement();m.load("TinyMCE");return m.getAttribute(l);},removeItem:function(l){k.getElement().removeAttribute(l);}};}}],function(m){try{j.storage=m();if(j.storage){return false;}}catch(l){}});},storeDraft:function(){var l=this,j=l.storage,k=l.editor,i,h;if(j){if(!j.getItem(l.key)&&!k.isDirty()){return;}h=k.getContent({draft:true});if(h.length>k.settings.autosave_minlength){i=l.getExpDate();if(!l.storage.autoExpires){l.storage.setItem(l.key+"_expires",i);}l.storage.setItem(l.key,h);l.onStoreDraft.dispatch(l,{expires:i,content:h});}}},restoreDraft:function(){var h=this,i=h.storage;if(i){content=i.getItem(h.key);if(content){h.editor.setContent(content);h.onRestoreDraft.dispatch(h,{content:content});}}},hasDraft:function(){var k=this,i=k.storage,j,h;if(i){h=!!i.getItem(k.key);if(h){if(!k.storage.autoExpires){j=new Date(i.getItem(k.key+"_expires"));if(new Date().getTime()<j.getTime()){return b;}k.removeDraft();}else{return b;}}}return false;},removeDraft:function(){var k=this,j=k.storage,i=k.key,h;if(j){h=j.getItem(i);j.removeItem(i);j.removeItem(i+"_expires");if(h){k.onRemoveDraft.dispatch(k,{content:h});}}},"static":{_beforeUnloadHandler:function(i){var h;d.each(tinyMCE.editors,function(j){if(j.plugins.autosave){j.plugins.autosave.storeDraft();}if(j.getParam("fullscreen_is_enabled")){return;}if(!h&&j.isDirty()&&j.getParam("autosave_ask_before_unload")){h=j.getLang("autosave.unload_msg");}});return h;}}});d.PluginManager.add("autosave",d.plugins.AutoSave);})(tinymce);