(function(){tinymce.create("tinymce.plugins.Layer",{init:function(c,a){var b=this;b.editor=c;c.addCommand("mceInsertLayer",b._insertLayer,b);c.addCommand("mceMoveForward",function(){b._move(1);});c.addCommand("mceMoveBackward",function(){b._move(-1);});c.addCommand("mceMakeAbsolute",function(){b._toggleAbsolute();});c.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"});c.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"});c.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"});c.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"});c.onInit.add(function(){if(tinymce.isIE){c.getDoc().execCommand("2D-Position",false,true);}});c.onNodeChange.add(b._nodeChange,b);c.onVisualAid.add(b._visualAid,b);},getInfo:function(){return{longname:"Layer",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/layer",version:tinymce.majorVersion+"."+tinymce.minorVersion};},_nodeChange:function(e,c,b){var a,d;a=this._getParentLayer(b);d=e.dom.getParent(b,"DIV,P,IMG");if(!d){c.setDisabled("absolute",1);c.setDisabled("moveforward",1);c.setDisabled("movebackward",1);}else{c.setDisabled("absolute",0);c.setDisabled("moveforward",!a);c.setDisabled("movebackward",!a);c.setActive("absolute",a&&a.style.position.toLowerCase()=="absolute");}},_visualAid:function(c,d,b){var a=c.dom;tinymce.each(a.select("div,p",d),function(f){if(/^(absolute|relative|static)$/i.test(f.style.position)){if(b){a.addClass(f,"mceItemVisualAid");}else{a.removeClass(f,"mceItemVisualAid");}}});},_move:function(j){var b=this.editor,a,c=[],h=this._getParentLayer(b.selection.getNode()),f=-1,g=-1,e;e=[];tinymce.walk(b.getBody(),function(d){if(d.nodeType==1&&/^(absolute|relative|static)$/i.test(d.style.position)){e.push(d);}},"childNodes");for(a=0;a<e.length;a++){c[a]=e[a].style.zIndex?parseInt(e[a].style.zIndex):0;if(f<0&&e[a]==h){f=a;}}if(j<0){for(a=0;a<c.length;a++){if(c[a]<c[f]){g=a;break;}}if(g>-1){e[f].style.zIndex=c[g];e[g].style.zIndex=c[f];}else{if(c[f]>0){e[f].style.zIndex=c[f]-1;}}}else{for(a=0;a<c.length;a++){if(c[a]>c[f]){g=a;break;}}if(g>-1){e[f].style.zIndex=c[g];e[g].style.zIndex=c[f];}else{e[f].style.zIndex=c[f]+1;}}b.execCommand("mceRepaint");},_getParentLayer:function(a){return this.editor.dom.getParent(a,function(b){return b.nodeType==1&&/^(absolute|relative|static)$/i.test(b.style.position);});},_insertLayer:function(){var a=this.editor,b=a.dom.getPos(a.dom.getParent(a.selection.getNode(),"*"));a.dom.add(a.getBody(),"div",{style:{position:"absolute",left:b.x,top:(b.y>20?b.y:20),width:100,height:100},"class":"mceItemVisualAid"},a.selection.getContent()||a.getLang("layer.content"));},_toggleAbsolute:function(){var a=this.editor,b=this._getParentLayer(a.selection.getNode());if(!b){b=a.dom.getParent(a.selection.getNode(),"DIV,P,IMG");}if(b){if(b.style.position.toLowerCase()=="absolute"){a.dom.setStyles(b,{position:"",left:"",top:"",width:"",height:""});a.dom.removeClass(b,"mceItemVisualAid");}else{if(b.style.left==""){b.style.left=20+"px";}if(b.style.top==""){b.style.top=20+"px";}if(b.style.width==""){b.style.width=b.width?(b.width+"px"):"100px";}if(b.style.height==""){b.style.height=b.height?(b.height+"px"):"100px";}b.style.position="absolute";a.addVisual(a.getBody());}a.execCommand("mceRepaint");a.nodeChanged();}}});tinymce.PluginManager.add("layer",tinymce.plugins.Layer);})();