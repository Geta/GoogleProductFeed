(function(a,c){var b=a.dom.Event;a.PluginManager.requireLangPack("epidynamiccontent");a.create("tinymce.plugins.epidynamiccontent",{_onInitCalled:false,init:function(g,d){var e=this;if(typeof EPi==="undefined"||typeof EPi.ResolveUrlFromUI!="function"){return;}if(typeof epiContentBlockUtilities=="undefined"){var f=a.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");a.ScriptLoader.load(f,function(){this._init(g,d);},this);a.ScriptLoader.loadQueue();}else{this._init(g,d);}g.addButton("epidynamiccontent",{title:"epidynamiccontent.desc",cmd:"mceEPiDynamicContent"});g.onInit.add(function(){e._onInitCalled=true;});},_init:function(h,d){c.extend(this,epiContentBlockUtilities);var g=this,e;g._url=d;g.ed=h;g._disabled=false;e=g._dynamicContentClass=h.getParam("epidynamiccontent_cssclass","epi_dc");g._enabledControls=h.getParam("epidynamiccontent_enabledcontrols","");h.addCommand("mceEPiDynamicContent",function(){var m=c.extend({},h.settings.epi_page_context);c(document).trigger("epi.loading.page_context",m);var n=EPi.ResolveUrlFromUI("Editor/Dialogs/DynamicContent.aspx")+"?"+c.param(m);var w=null;var u=function(y,z){var x=h.selection;if(!y){h.windowManager.onClose.dispatch();return;}if(w){x.select(w);}h.getWin().focus();var A=g._getParentContentBlock(x.getNode());if(A){h.dom.remove(A);}if(y.match("^<div")){A=g._insertContent(y);}else{A=g._insertInlineContent(y);}g._moveToAdjacentNode(A,true);g._onContentChanged();h.windowManager.onClose.dispatch();};var k=h.selection;w=g._getParentContentBlock(k.getStart());var l={width:600,height:640};var j=g._getAllContentGroups(h);if(w){var i=EPi.ResolveUrlFromUtil("../App_Themes/Default/Styles/system.css");var q=w.getAttribute("data-groups");var t=q?q.replace(/"/g,"&quot;"):"";var r=w.getAttribute("data-contentgroup");var o=r?r.replace(/"/g,"&quot;"):"";var p='<html xmlns="http://www.w3.org/1999/xhtml"><head><link href="'+i+'" type="text/css" rel="stylesheet" /><title></title></head><body onload="document.forms[0].submit()"><form action="'+n+'" method="post"><input name="state" type="hidden" value="'+w.getAttribute("data-state").replace(/"/g,"&quot;")+'" /><input name="hash" type="hidden" value="'+w.getAttribute("data-hash").replace(/"/g,"&quot;")+'" /><input name="dynamicclass" type="hidden" value="'+w.getAttribute("data-dynamicclass").replace(/"/g,"&quot;")+'" /><input name="groups" type="hidden" value="'+t+'" /><input name="contentgroup" type="hidden" value="'+o+'" /><input name="allcontentgroups" type="hidden" value="'+j+'" /></form></body></html>';h.windowManager.onOpen.dispatch();var v=EPi.CreateDialog("",u,null,null,l);v._dialog.document.write(p);v._dialog.document.close();}else{n+="&allcontentgroups="+j;h.windowManager.onOpen.dispatch();EPi.CreateDialog(n,u,null,null,l);}});var f=function(i){var j=c(i.getBody());if(j.length){j.bind("drop",function(k){if(c(k.target).closest("."+e).length){return false;}});}c(i.dom.doc).click(function(k){g._handleButtonsClick(k);});i.onNodeChange.addToTop(function(k,q,o,t,v){var u=k.selection;var r=null;if(u.isCollapsed()){r=g._getParentContentBlock(u.getNode());}else{r=g._getParentContentBlock(u.getStart())||g._getParentContentBlock(u.getEnd());}if(a.isIE&&!r&&u.isCollapsed()){var p=k.selection.getRng(true);var m=p.commonAncestorContainer;if(m&&m.nodeType===1){if(k.dom.hasClass(m.childNodes[p.startOffset],g._dynamicContentClass)){r=m.childNodes[p.startOffset];}}}if(r){g._selectContentBlock(k,r);g._updateCommandState(false);g._showButton(k,q,true,true);if(a.isIE&&t&&(k.dom.hasClass(o,"epi_dc_editBtn")||k.dom.hasClass(o,"epi_dc_previewBtn"))){g._handleButtonsClick({target:o});}var l=(v.initial===1);if(!l){g._updateUndoRedoButtons(q);}return l;}else{g._updateCommandState(true);g._showButton(k,q,t,false);}});i.onKeyDown.addToTop(function(l,o){if((o.keyCode<37||o.keyCode>40)&&o.keyCode!=13&&o.keyCode!=8&&o.keyCode!=46&&o.keyCode!=32){return;}var k=l.selection;var n=g._getParentContentBlock(k.getNode());if(o.keyCode==8||o.keyCode==46){if(g._handleDeleteKeys(n||g._getParentContentBlock(k.getEnd()),o.keyCode===8)){return a.dom.Event.cancel(o);}return;}if(!n){return;}if(o.keyCode==13){g._handleEnterKey();return;}if(o.keyCode>=37&&o.keyCode<=40){var m=o.keyCode==39||o.keyCode==40;g._moveToAdjacentNode(n,m);return a.dom.Event.cancel(o);}});};if(g._onInitCalled){f(h);}else{h.onInit.add(f);}},_showButton:function(h,g,f,d){var e=h.dom.isHidden(h.container);g.setDisabled("epidynamiccontent",e||!f);g.setActive("epidynamiccontent",!e&&d);},_handleButtonsClick:function(f){if(this.ed.dom.hasClass(f.target,"epi_dc_editBtn")&&(f.button===0)){this._hidePreview();var d=this._getParentContentBlock(f.target);this.ed.focus();this.ed.selection.select(d);tinyMCE.execCommand("mceEPiDynamicContent");return a.dom.Event.cancel(f);}else{if(c(f.target).is(".epi_dc_previewBtn")&&(f.button===0)){this._showPreview(f.target);return a.dom.Event.cancel(f);}else{this._hidePreview();}}},_createNewNode:function(d){if(d){return this.ed.getDoc().createTextNode("");}else{return this.ed.dom.create("p",null,'<br _mce_bogus="1" />');}},_getParentContentBlock:function(d){return this._getParentNode(d,this._dynamicContentClass);},getInfo:function(){return{longname:"Dynamic content plugin",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:1.1};},_moveToAdjacentNode:function(d,e){nodeIsInline=!this.ed.dom.isBlock(d);var f;if(e){if(nodeIsInline){f=d.nextSibling;}if(!f){f=c(d).next()[0];}if(!f||f.tagName=="BR"){f=this._createNewNode(nodeIsInline);this.ed.dom.insertAfter(f,d);}this._moveSelection(f,true);}else{if(nodeIsInline){f=d.previousSibling;}if(!f){f=c(d).prev()[0];}if(!f){f=this._createNewNode(nodeIsInline);d.parentNode.insertBefore(f,d);}this._moveSelection(f,false);}},_block:function(f,g){var d=g.keyCode;if((d>32&&d<41)||(d>111&&d<124)||g.ctrlKey||g.metaKey){return;}else{if((g.type=="keydown")&&(d==13||d==46||d==8)){return;}}return a.dom.Event.cancel(g);},_handleEnterKey:function(){var d=this._getParentContentBlock(this.ed.selection.getNode());if(!this._isNull(d)){this._ensureInitialUndoLevel();this._insertParagraphBefore(d);this._onContentChanged();}},_handleDeleteKeys:function(d,h){if(!this._isNull(d)){this._ensureInitialUndoLevel();this.ed.dom.remove(d);this._onContentChanged();return true;}else{if(!this.ed.selection.isCollapsed()){return false;}var g=this.ed.selection.getRng(true);if(h){var e=this._getCaretPosition(g.startContainer);var i=this._getPreviousCaretNode(g.startContainer);if(e===0&&!this._isNull(i)&&this.ed.dom.hasClass(i,this._dynamicContentClass)){this._selectContentBlock(this.ed,i);return true;}}else{var e=this._getCaretPosition(g.endContainer);var f=this._getNextCaretNode(g.endContainer,e);if(this._caretIsAtTheEnd(g.endContainer,e)&&!this._isNull(f)&&this.ed.dom.hasClass(f,this._dynamicContentClass)){if(e==0){this.ed.dom.remove(this.ed.selection.getNode());}this._selectContentBlock(this.ed,f);return true;}}}return false;},_url:null,_previewedDynamicContent:null,_previewVisible:false,_lastSelection:null,_showPreview:function(f){if(this._hidePreview()){c(window["epi-dcPreview"].document.documentElement).remove();}var e=c("<div/>",this.document).append(c(f).closest(".epi_dc").clone()).html();this._previewedDynamicContent=e;var d=this;setTimeout(function(){if(e!==d._previewedDynamicContent){return;}d._previewVisible=true;d._lastSelection=f;var i=c("iframe",d.ed.container);var h=d._getPositionInParentFrame(f,d.ed.contentWindow,i,window);var g=d.ed.settings.editorwidth?d.ed.settings.editorwidth:d.ed.settings.width;var k=d._createPopupIframe(h,"epi-dcPreview",g,[{onclick:function(){d._openEditDialog(d.ed);d._hidePreview();},text:d.ed.translate("epidynamiccontent.edit")},{onclick:function(){d._hidePreview();},text:d.ed.translate("epidynamiccontent.close")}]);var j=d._getPreviewUrl();var l={DynamicContent:e};d._postFrameTo(k,j,l);c(window).bind("resize.dynamicContent",function(o){var m=d._getPositionInParentFrame(f,d.ed.contentWindow,i,window);var n=c("#epi-dcPreview");n.css(m);});},250);},_getPreviewUrl:function(){var e="Editor/Dialogs/DynamicContentPreview.aspx";var d=jQuery.extend({content_css:this.ed.settings.content_css},this.ed.settings.epi_page_context);c(document).trigger("epi.loading.page_context",d);return EPi.ResolveUrlFromUI(e+"?"+jQuery.param(d));},_openEditDialog:function(){this.ed.focus();var d=this._getParentContentBlock(this._lastSelection);this.ed.selection.select(d);tinyMCE.execCommand("mceEPiDynamicContent");},_hidePreview:function(){this._previewedDynamicContent=null;if(!this._previewVisible){return false;}this._previewVisible=false;this._lastSelection=null;c("#epi-dcPreview").hide();c(window).unbind("resize.dynamicContent");return true;},_getPositionInParentFrame:function(g,m,e,o){var q=c(e).offset();var p=c(g).position();var i={y:c(o).scrollTop(),x:c(o).scrollLeft()};var j={y:Math.max(c(m.document.body).scrollTop(),c(m.document.documentElement).scrollTop()),x:c(m.document.body).scrollLeft()};var n={top:q.top+p.top-i.y-j.y,left:q.left+p.left+Math.min(c(g).width()+10,c(e).width())-i.x-j.x};if(i.y>0&&(a.isGecko||a.isWebKit)){n.top+=j.y;}if(a.isIE){n.top+=i.y;}var h=c(o);var f=n.top+300;var d=i.y+h.height();if(f>d){n.top=Math.max(i.y,n.top-f+d);}var l=this.ed.settings.editorwidth?this.ed.settings.editorwidth:this.ed.settings.width;f=n.left+parseInt(l,10)+24;var k=i.x+h.width();if(f>k){n.left=Math.max(i.x,n.left-f+k);}return n;},_createPopupIframe:function(f,k,g,l){var j=this;var h=c("#"+k).show();if(h.length===0){h=c("<div id='"+k+"' class='epi-dcPreviewBorder'><iframe frameborder='0' style='height:300px;' class='episystemiframe' name='"+k+"' src=''></iframe><div id='epi-dcPreviewButtons'></div><div id='epi-dcPreviewDescription'></div></div>").appendTo(window.document.body);c(window.document.body).click(function(){j._hidePreview();});}h.css({position:"absolute",top:f.top,left:f.left,width:g}).children("iframe").css({height:"250px",width:"100%"});if(l){c("#epi-dcPreviewButtons").html("");for(var d in l){c("<span class='epi-cmsButton'><input type='button' value='"+l[d].text+"'/></span>").appendTo("#epi-dcPreviewButtons").click(l[d].onclick);}}var e=window[k];return e;},_postFrameTo:function(f,d,e){var g='<html xmlns="http://www.w3.org/1999/xhtml" style="height:100%;background:#fff url('+EPi.ResolveUrlFromUtil("../App_Themes/Default/Images/General/AjaxLoader.gif")+') no-repeat 50% 50%"><head><title></title></head><body>';g+='<form action="'+d+'" method="post">';var h;for(h in e){g+='<input name="'+h+'" id="'+h+'" type="hidden" />';}g+="</form></body></html>";f.document.write(g);for(h in e){f.document.getElementById(h).value=e[h];}f.document.forms[0].submit();}});a.PluginManager.add("epidynamiccontent",a.plugins.epidynamiccontent);}(tinymce,epiJQuery));