(function(){var b=tinymce.util.JSONRequest,c=tinymce.each,a=tinymce.DOM;tinymce.create("tinymce.plugins.SpellcheckerPlugin",{getInfo:function(){return{longname:"Spellchecker",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/spellchecker",version:tinymce.majorVersion+"."+tinymce.minorVersion};},init:function(g,d){var e=this,f;e.url=d;e.editor=g;e.rpcUrl=g.getParam("spellchecker_rpc_url","{backend}");if(e.rpcUrl=="{backend}"){if(tinymce.isIE){return;}e.hasSupport=true;g.onContextMenu.addToTop(function(h,i){if(e.active){return false;}});}g.addCommand("mceSpellCheck",function(){if(e.rpcUrl=="{backend}"){e.editor.getBody().spellcheck=e.active=!e.active;return;}if(!e.active){g.setProgressState(1);e._sendRPC("checkWords",[e.selectedLang,e._getWords()],function(h){if(h.length>0){e.active=1;e._markWords(h);g.setProgressState(0);g.nodeChanged();}else{g.setProgressState(0);if(g.getParam("spellchecker_report_no_misspellings",true)){g.windowManager.alert("spellchecker.no_mpell");}}});}else{e._done();}});g.onInit.add(function(){if(g.settings.content_css!==false){g.dom.loadCSS(d+"/css/content.css");}});g.onClick.add(e._showMenu,e);g.onContextMenu.add(e._showMenu,e);g.onBeforeGetContent.add(function(){if(e.active){e._removeWords();}});g.onNodeChange.add(function(h,i){i.setActive("spellchecker",e.active);});g.onSetContent.add(function(){e._done();});g.onBeforeGetContent.add(function(){e._done();});g.onBeforeExecCommand.add(function(h,i){if(i=="mceFullScreen"){e._done();}});e.languages={};c(g.getParam("spellchecker_languages","+English=en,Danish=da,Dutch=nl,Finnish=fi,French=fr,German=de,Italian=it,Polish=pl,Portuguese=pt,Spanish=es,Swedish=sv","hash"),function(i,h){if(h.indexOf("+")===0){h=h.substring(1);e.selectedLang=i;}e.languages[h]=i;});},createControl:function(h,g){var f=this,e,d=f.editor;if(h=="spellchecker"){if(f.rpcUrl=="{backend}"){if(f.hasSupport){e=g.createButton(h,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:f});}return e;}e=g.createSplitButton(h,{title:"spellchecker.desc",cmd:"mceSpellCheck",scope:f});e.onRenderMenu.add(function(j,i){i.add({title:"spellchecker.langs","class":"mceMenuItemTitle"}).setDisabled(1);c(f.languages,function(p,m){var l={icon:1},n;l.onclick=function(){n.setSelected(1);f.selectedItem.setSelected(0);f.selectedItem=n;f.selectedLang=p;};l.title=m;n=i.add(l);n.setSelected(p==f.selectedLang);if(p==f.selectedLang){f.selectedItem=n;}});});return e;}},_walk:function(i,e){var h=this.editor.getDoc(),g;if(h.createTreeWalker){g=h.createTreeWalker(i,NodeFilter.SHOW_TEXT,null,false);while((i=g.nextNode())!=null){e.call(this,i);}}else{tinymce.walk(i,e,"childNodes");}},_getSeparators:function(){var e="",d,f=this.editor.getParam("spellchecker_word_separator_chars",'\\s!"#$%&()*+,-./:;<=>?@[]^_{|}§©«®±¶·¸»¼½¾¿×÷¤\u201d\u201c');for(d=0;d<f.length;d++){e+="\\"+f.charAt(d);}return e;},_getWords:function(){var h=this.editor,g=[],f="",d={},e=[];this._walk(h.getBody(),function(i){if(i.nodeType==3){f+=i.nodeValue+" ";}});if(h.getParam("spellchecker_word_pattern")){e=f.match("("+h.getParam("spellchecker_word_pattern")+")","gi");}else{f=f.replace(new RegExp("([0-9]|["+this._getSeparators()+"])","g")," ");f=tinymce.trim(f.replace(/(\s+)/g," "));e=f.split(" ");}c(e,function(i){if(!d[i]){g.push(i);d[i]=1;}});return g;},_removeWords:function(h){var f=this.editor,d=f.dom,g=f.selection,e=g.getBookmark();c(d.select("span").reverse(),function(i){if(i&&(d.hasClass(i,"mceItemHiddenSpellWord")||d.hasClass(i,"mceItemHidden"))){if(!h||d.decode(i.innerHTML)==h){d.remove(i,1);}}});g.moveToBookmark(e);},_markWords:function(l){var h,i,p,e,g,f="",d=this.editor,m=this._getSeparators(),k=d.dom,o=[];var n=d.selection,j=n.getBookmark();c(l,function(q){f+=(f?"|":"")+q;});h=new RegExp("(["+m+"])("+f+")(["+m+"])","g");i=new RegExp("^("+f+")","g");p=new RegExp("("+f+")(["+m+"]?)$","g");e=new RegExp("^("+f+")(["+m+"]?)$","g");g=new RegExp("("+f+")(["+m+"])","g");this._walk(this.editor.getBody(),function(q){if(q.nodeType==3){o.push(q);}});c(o,function(q){var r;if(q.nodeType==3){r=q.nodeValue;if(h.test(r)||i.test(r)||p.test(r)||e.test(r)){r=k.encode(r);r=r.replace(g,'<span class="mceItemHiddenSpellWord">$1</span>$2');r=r.replace(p,'<span class="mceItemHiddenSpellWord">$1</span>$2');k.replace(k.create("span",{"class":"mceItemHidden"},r),q);}}});n.moveToBookmark(j);},_showMenu:function(g,k){var l=this,g=l.editor,h=l._menu,j,d=g.dom,f=d.getViewPort(g.getWin()),i=k.target;k=0;if(!h){j=a.getPos(g.getContentAreaContainer());h=g.controlManager.createDropMenu("spellcheckermenu",{offset_x:j.x,offset_y:j.y,"class":"mceNoIcons"});l._menu=h;}if(d.hasClass(i,"mceItemHiddenSpellWord")){h.removeAll();h.add({title:"spellchecker.wait","class":"mceMenuItemTitle"}).setDisabled(1);l._sendRPC("getSuggestions",[l.selectedLang,d.decode(i.innerHTML)],function(e){var m;h.removeAll();if(e.length>0){h.add({title:"spellchecker.sug","class":"mceMenuItemTitle"}).setDisabled(1);c(e,function(n){h.add({title:n,onclick:function(){d.replace(g.getDoc().createTextNode(n),i);l._checkDone();}});});h.addSeparator();}else{h.add({title:"spellchecker.no_sug","class":"mceMenuItemTitle"}).setDisabled(1);}m=l.editor.getParam("spellchecker_enable_ignore_rpc","");h.add({title:"spellchecker.ignore_word",onclick:function(){var n=i.innerHTML;d.remove(i,1);l._checkDone();if(m){g.setProgressState(1);l._sendRPC("ignoreWord",[l.selectedLang,n],function(o){g.setProgressState(0);});}}});h.add({title:"spellchecker.ignore_words",onclick:function(){var n=i.innerHTML;l._removeWords(d.decode(n));l._checkDone();if(m){g.setProgressState(1);l._sendRPC("ignoreWords",[l.selectedLang,n],function(o){g.setProgressState(0);});}}});if(l.editor.getParam("spellchecker_enable_learn_rpc")){h.add({title:"spellchecker.learn_word",onclick:function(){var n=i.innerHTML;d.remove(i,1);l._checkDone();g.setProgressState(1);l._sendRPC("learnWord",[l.selectedLang,n],function(o){g.setProgressState(0);});}});}h.update();});g.selection.select(i);j=d.getPos(i);h.showMenu(j.x,j.y+i.offsetHeight-f.y);return tinymce.dom.Event.cancel(k);}else{h.hideMenu();}},_checkDone:function(){var f=this,g=f.editor,e=g.dom,d;c(e.select("span"),function(h){if(h&&e.hasClass(h,"mceItemHiddenSpellWord")){d=true;return false;}});if(!d){f._done();}},_done:function(){var e=this,d=e.active;if(e.active){e.active=0;e._removeWords();if(e._menu){e._menu.hideMenu();}if(d){e.editor.nodeChanged();}}},_sendRPC:function(f,g,d){var e=this;b.sendRPC({url:e.rpcUrl,method:f,params:g,success:d,error:function(h,i){e.editor.setProgressState(0);e.editor.windowManager.alert(h.errstr||("Error response: "+i.responseText));}});}});tinymce.PluginManager.add("spellchecker",tinymce.plugins.SpellcheckerPlugin);})();