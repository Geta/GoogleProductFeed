(function(b,a){b.create("tinymce.plugins.epipersonalizedcontent",{_onInitCalled:false,init:function(f,c){var d=this;if(typeof epiContentBlockUtilities=="undefined"){var e=b.baseURI.toAbsolute("plugins/epipersonalizedcontent/epicontentblockutilities.js");b.ScriptLoader.load(e,function(){this._init(f,c);},this);b.ScriptLoader.loadQueue();}else{this._init(f,c);}f.addButton("epipersonalizedcontent",{title:"epipersonalizedcontent.epipersonalizedcontent_desc",cmd:"epipersonalizedcontent","class":"mce_epipersonalizedcontent"});f.onInit.add(function(){d._onInitCalled=true;});},_init:function(f,c){a.extend(this,epiContentBlockUtilities);var e=this;e._pcIsSelecting=false;e._pcInClipboard=false;e._pcDragging=false;e._selectedPcHeader=null;e._activePcBlock=null;e._personalizedContentHeaderClass=f.getParam("epipersonalizedcontent_headercssclass","epi_pc_h");e._personalizedContentFooterClass=f.getParam("epipersonalizedcontent_footercssclass","epi_pc_f");e._personalizedContentClass=f.getParam("epipersonalizedcontent_cssclass","epi_pc");e._personalizedContentHolderClass=f.getParam("epipersonalizedcontent_holdercssclass","epi_pc_content");e.ed=f;e._disabled=false;e._enabledControls=f.getParam("epipersonalizedcontent_enabledcontrols","");f.addCommand("epipersonalizedcontent",function(){if(!e._validateAndCorrectSelection()){f.windowManager.alert(f.translate("epipersonalizedcontent.invalidselectionwarning"));return;}var l=e._getParentContentBlock(e._getCommonAncestor());var m=function(t,s){if(!t){f.windowManager.onClose.dispatch();return;}var n,q;var u;if(t.removePersonalization){u=f.dom.select("."+e._personalizedContentHolderClass,l)[0];n=u.innerHTML;f.dom.setOuterHTML(l,n);}else{if(l){u=f.dom.select("."+e._personalizedContentHolderClass,l);n=a(u).html();q=t.replace("[personalizedContentPlaceHolder]",n);f.dom.setOuterHTML(l,q);}else{n=f.selection.getContent();if(n===""){n='<p><br mce_bogus="1" /></p>';}else{var r={content:n};f.onBeforeSetContent.dispatch(this,r);n=r.content;}q=t.replace("[personalizedContentPlaceHolder]",n);q=q.replace(e._personalizedContentHolderClass,e._personalizedContentHolderClass+" mce_bogus");e._insertContent(q);u=f.dom.select("div.mce_bogus")[0];e._normalizeContentNode(u);f.dom.removeClass(u,"mce_bogus");var p=a(u).children(":last")[0];f.onSetContent.dispatch(f);e._moveSelection(p,false);}}f.undoManager.add();f.nodeChanged();f.windowManager.onClose.dispatch();};var g={width:600,height:450};var j=EPi.ResolveUrlFromUI("Editor/Dialogs/PersonalizedContent.aspx");var k={allContentGroups:e._getAllContentGroups()};if(!b.isIE){var i=f.selection.getNode();var h=i.nodeName!=="BODY"&&i.nodeName!=="LI"&&i.nodeName!=="TD";if(h&&f.selection.getStart()===f.selection.getEnd()){f.selection.select(i);}}if(l){k.groups=f.dom.getAttrib(l,"data-groups","");k.contentGroup=f.dom.getAttrib(l,"data-contentgroup","");}else{if(f.selection.isCollapsed()){return;}}f.windowManager.onOpen.dispatch();EPi.CreateDialog(j+"?"+a.param(k),m,null,null,g);});var d=function(g){var h=a(g.getBody());if(h.length){a(h).bind("drop",function(i){var j=i.srcElement||i.originalTarget;if(j===h[0]&&j.ownerDocument.elementFromPoint){j=j.ownerDocument.elementFromPoint(i.clientX,i.clientY);}if(j===h[0]){j=g.selection.isCollapsed()?g.selection.getNode():j;}if(a(j).closest("."+e._personalizedContentClass).length&&(!a(j).closest("."+e._personalizedContentHolderClass).length)){return false;}if(e._pcDragging&&a(j).closest("."+e._personalizedContentClass).length){return false;}});h.bind("dragstart",function(i){if(e._selectionContainsPC()){e._pcDragging=true;}else{e._pcDragging=false;}});h.bind("dragend",function(i){if(e._pcDragging){e._pcDragging=false;}});h.bind("cut",function(i){if(e._selectionContainsPC()){e._pcInClipboard=true;}else{e._pcInClipboard=false;}});h.bind("copy",function(i){if(e._selectionContainsPC()){e._pcInClipboard=true;}else{e._pcInClipboard=false;}});h.bind("paste",function(i){if(e._pcInClipboard&&a(i.srcElement||i.originalTarget).closest("."+e._personalizedContentClass).length){e._toCancelPasting=true;return false;}});}a(g.dom.doc).click(function(i){if(g.dom.hasClass(i.target,"epi_pc_editBtn")&&(i.button===0)){e._handleButtonsClick(i);}});if(b.isIE){a(g.getBody()).blur(function(i){e._onEditorDeactivated();});g.dom.bind(g.getDoc(),"controlselect",function(j){if(e._isIE9StandardMode()){return true;}var i=j.target;if(!e._pcIsSelecting&&(g.dom.getParent(i,"."+e._personalizedContentHeaderClass)||g.dom.getParent(i,"."+e._personalizedContentFooterClass))){e._pcIsSelecting=true;setTimeout(function(){var k=e._getParentContentBlock(i);if(k){e._handlePCSelection(k);e._pcIsSelecting=false;}},1);return false;}});}else{a(g.dom.doc).blur(function(i){e._onEditorDeactivated();});}};if(e._onInitCalled){d(f);}else{f.onInit.add(d);}f.onPreProcess.add(function(g,h){if(h.get){g.dom.removeClass(g.dom.select("div.mceSelected"),"mceSelected");g.dom.setAttrib(g.dom.select("div."+e._personalizedContentClass),"contentEditable",null);}});f.onNodeChange.addToTop(function(g,j,r,i,t){if(t.initial===1){e._showButton(g,j,false,false);return;}if(b.isIE&&i&&g.dom.hasClass(r,"epi_pc_editBtn")){e._handleButtonsClick({target:r});}if(!i){r=e._getCommonAncestor();}var l=g.selection;var k=e._getParentContentBlock(l.getStart());var w=e._getParentContentBlock(l.getEnd());var u=k||w;var h;var m=false;var o=(k||w)&&(k!==w);var x=e._overlapsHeadingMargin(l);if(o||x){h=k||w;r=h;m=true;}else{h=e._getParentContentBlock(r);}if(h&&!e._pcIsSelecting&&((g.dom.hasClass(r,e._personalizedContentClass)&&(g.selection.isCollapsed()||g.selection.getSel().type=="Control"))||g.dom.getParent(r,"."+e._personalizedContentHeaderClass)||g.dom.getParent(r,"."+e._personalizedContentFooterClass)||m)){e._pcIsSelecting=true;setTimeout(function(){if(m&&b.isIE){var n=k?l.getEnd():(w?l.getStart():null);if(n){g.selection.select(n);}}e._handlePCSelection(h);e._pcIsSelecting=false;},1);}if(g.dom.hasClass(r,e._personalizedContentHolderClass)){e._normalizeContentNode(r);if(i){e._moveSelection(a(r).children(":last")[0],false);}}var q=e._getParentContentBlockHeader(r)||e._getPCContentBlockHeader(r);e._updateSelectedElements(r,h,q);var v=(q===null);e._updateCommandState(q===null);var p=!e._isNull(h)||!i;e._showButton(g,j,p,!e._isNull(h));if(!v){e._updateUndoRedoButtons(j);}return v;});f.onPaste.add(function(g,h){if(e._toCancelPasting){e._toCancelPasting=false;return b.dom.Event.cancel(h);}setTimeout(function(){var j=g.dom.select(".mceSelected."+e._personalizedContentClass);for(var k=0;k<j.length;k++){g.dom.removeClass(j[k],"mceSelected");}},1);});f.onKeyUp.addToTop(function(i,p){var j=p.keyCode;if(!(j>=37&&j<=40)){return;}var m=e._getCommonAncestor();var q=e._getParentContentBlock(m);if(!q){return;}var h=(q===m)?e._getCaretPosition(m):0;var n=(q===m)&&(h==0);var o=(q===m)&&(h>0);var l=i.dom.getParent(m,"."+e._personalizedContentHeaderClass);var g=i.dom.getParent(m,"."+e._personalizedContentFooterClass);if(j==37||j==38){if(n){e._moveUp(q,false);}else{if(o||g){e._moveUp(q,true);}}}else{if(j==39||j==40){if(o||g){e._moveDown(q,false);}}}});f.onKeyDown.addToTop(function(i,o){var j=o.keyCode;if(!((j>=37&&j<=40)||j==8||j==46||j==13)){if(i.dom.getParent(i.selection.getStart(),"."+e._personalizedContentClass)&&!i.dom.getParent(i.selection.getStart(),"."+e._personalizedContentHolderClass)&&!o.ctrlKey&&!o.metaKey){return b.dom.Event.cancel(o);}return;}if(o.shiftKey&&j>=37&&j<=40){return;}var p,l=e._getCommonAncestor();if(i.selection.getRng()&&i.selection.getRng().item){var r=i.selection.getRng().item(0);p=i.dom.hasClass(r,e._personalizedContentClass)?r:null;if(p){p.removeAttribute("contentEditable");if(document.selection){document.selection.empty();}}}else{p=e._getParentContentBlock(l);}if(!p){if(j==46||j==8){if(e._validateSelectionBeforeDeletion()){return b.dom.Event.cancel(o);}else{if(i.selection.isCollapsed()){var n=i.selection.getNode();var m=e._getPreviousCaretNode(n);if(j==8&&m&&i.dom.hasClass(m,e._personalizedContentClass)){if(e._getCaretPosition(n)==0){e._moveUp(m,true);return b.dom.Event.cancel(o);}}var q=e._getNextCaretNode(n);if(j==46&&q&&i.dom.hasClass(q,e._personalizedContentClass)){var h=e._getCaretPosition(n);if(e._caretIsAtTheEnd(n,h)){e._moveDown(q,true);if(h==0){i.dom.remove(n);}return b.dom.Event.cancel(o);}}}}}return;}var g=false;if((p===l)&&(j==39||j==40)){g=e._moveDown(p,true);}else{if(j==37||j==38){if(p===l){g=e._moveUp(p,false);}else{if(b.isIE){var m=e._getPreviousCaretNode(l);if(i.dom.hasClass(m,e._personalizedContentHeaderClass)&&e._getCaretPosition(l)==0){e._moveSelection(m,true);g=true;}}}}else{if(j==46||j==8){g=e._handleDeletion(p,j==8);}else{if(j==13){g=e._handleEnterKey(p);}}}}if(g){return b.dom.Event.cancel(o);}});},_showButton:function(g,f,e,c){var d=g.dom.isHidden(g.container);f.setDisabled("epipersonalizedcontent",d||!e);f.setActive("epipersonalizedcontent",!d&&c);},_handleButtonsClick:function(c){this.ed.focus();if(!b.isIE){this.ed.selection.select(c.target);}tinyMCE.execCommand("epipersonalizedcontent");return b.dom.Event.cancel(c);},_handlePCSelection:function(d){var c=this;c._selectContentBlock(c.ed,d);var e=function(f){c.ed.dom.unbind(c.ed.dom.doc,"click",e);if(!d||!d.parentNode){return;}c._deselectContentBlock(c.ed,d);c._updateSelectedElements(d,d,null);c._updateCommandState(true);var g=f.originalTarget||f.srcElement;if(c.ed.dom.getParent(g,"."+c._personalizedContentClass)){c._moveDown(d,true);return b.dom.Event.cancel(f);}};c.ed.dom.unbind(c.ed.dom.doc,"click",e);c.ed.dom.bind(c.ed.dom.doc,"click",e);},_handleEnterKey:function(d){var c=this._getParentContentBlockHolder(this._getCommonAncestor());if(!this._isNull(c)){this._normalizeContentNode(c);}else{pcHeader=this._getParentContentBlockHeader(this._getCommonAncestor())||this._getPCContentBlockHeader(this._getCommonAncestor());if(!this._isNull(pcHeader)){this._ensureInitialUndoLevel();this._insertParagraphBefore(d);this._onContentChanged();return true;}}return false;},_onEditorDeactivated:function(){if(!this._isNull(this._selectedPcHeader)){this.ed.dom.removeClass(this._selectedPcHeader.parentNode,"mceSelected");this._selectedPcHeader=null;}},_updateSelectedElements:function(f,d,c){if(this._selectedPcHeader===c){return;}if(!this._isNull(this._selectedPcHeader)){this.ed.dom.removeClass(this._selectedPcHeader.parentNode,"mceSelected");this._selectedPcHeader=null;}var e=this._getParentContentBlockHolder(f);if(this._activePcBlock===e){}else{if(!this._isNull(this._activePcBlock)){this._normalizeContentNode(this._activePcBlock);this._activePcBlock=null;}if(!this._isNull(e)){this._activePcBlock=e;}}if(c!==null){this.ed.dom.addClass(d,"mceSelected");this._selectedPcHeader=c;}},_validateAndCorrectSelection:function(){var e=this._getCommonAncestor();var f=this.ed.selection.getStart();var d=this.ed.selection.getEnd();if(f!==d){if(this._isInvalidPartialSelectionElement(f)||this._isInvalidPartialSelectionElement(d)){if(e.nodeName=="TR"||e.nodeName=="TH"||e.nodeName=="TBODY"||e.nodeName=="THEAD"){e=this.ed.dom.getParent(e,"table");this.ed.selection.select(e);return true;}else{if(e.nodeName=="TABLE"||e.nodeName=="UL"||e.nodeName=="OL"){this.ed.selection.select(e);return true;}}return false;}}var e=this._getCommonAncestor();if(!this.ed.dom.isBlock(e)){var g=this;e=this.ed.dom.getParent(e,function(h){return g.ed.dom.isBlock(h);});}if(!this._isNull(e)){if(!this.ed.dom.hasClass(e,this._personalizedContentClass)){var c=tinyMCE.activeEditor.dom.select("div."+this._personalizedContentClass,e);if(c.length>0){return false;}}}else{return this.ed.selection.getContent().match(this._personalizedContentClass)===null;}return true;},_isInvalidPartialSelectionElement:function(c){return c.nodeName=="TD"||c.nodeName=="TR"||c.nodeName=="TH"||c.nodeName=="TBODY"||c.nodeName=="THEAD"||c.nodeName=="LI";},_selectionContainsPC:function(){var c=new RegExp("<div.*"+this._personalizedContentClass+".*>(\\n|.)*<div.*"+this._personalizedContentHeaderClass+".*>(\\n|.)*<div.*"+this._personalizedContentHolderClass+".*>(\\n|.)*<div.*"+this._personalizedContentFooterClass+".*>");return this.ed.selection.getContent().match(c);},_getCommonAncestor:function(){if(this.ed.selection.getStart()==this.ed.selection.getEnd()){return this.ed.selection.getStart();}var c=this.ed.selection.getRng(true).commonAncestorContainer;if(this._isNull(c)||c.tagName=="HTML"){return this.ed.getBody();}return c;},_getParentContentBlock:function(c){return this._getParentNode(c,this._personalizedContentClass);},_overlapsHeadingMargin:function(h){var e=a(h.getStart());var c=a(h.getEnd());var f=e.closest(".epi_pc_h").length==1;var g=c.closest(".epi_pc_h").length==1;if(b.isIE){var i=e.is(".epi_pc");var d=c.closest(".epi_pc_content").length==1;if(i&&d){return true;}}return(f&&!g)||(!f&&g);},_getParentContentBlockHolder:function(c){return this._getParentNode(c,this._personalizedContentHolderClass);},_getPCContentBlockHolder:function(c){if(this.ed.dom.hasClass(c,this._personalizedContentClass)){return a(c).children("."+this._personalizedContentHolderClass)[0];}else{return null;}},_getParentContentBlockHeader:function(c){return this._getParentNode(c,this._personalizedContentHeaderClass);},_getPCContentBlockHeader:function(c){if(this.ed.dom.hasClass(c,this._personalizedContentClass)){return a(c).children("."+this._personalizedContentHeaderClass)[0];}else{if(this.ed.dom.hasClass(c,this._personalizedContentFooterClass)){return a(c.parentNode).children("."+this._personalizedContentHeaderClass)[0];}else{return null;}}},_handleDeletion:function(i,e){if(this._deletePersonalizedContent(i)){return true;}else{var h=this.ed.selection.getNode();if(!e){var f=this._getNextCaretNode(h);if(this.ed.dom.hasClass(f,this._personalizedContentFooterClass)){var d=this._getCaretPosition(h);if(this._caretIsAtTheEnd(h,d)){this._moveDown(i,false);if(d==0){if(!(this.ed.dom.hasClass(h.parentNode,this._personalizedContentHolderClass)&&(h.parentNode.children.length==1))){this.ed.dom.remove(h);}}return true;}}}if(e){var g=this._getPreviousCaretNode(h);if(this.ed.dom.hasClass(g,this._personalizedContentHeaderClass)){if(this._getCaretPosition(h)==0){this._moveUp(i,false);return true;}}}}return this._blockContentBlockDeletion();},_deletePersonalizedContent:function(c){if(!this.ed.dom.hasClass(c,"mceSelected")){return false;}this._ensureInitialUndoLevel();this.ed.dom.remove(c);this._onContentChanged();return true;},_blockContentBlockDeletion:function(){var d=this._getCommonAncestor();var c=this._getParentContentBlockHolder(d);if(this._isNull(c)){return false;}var e=this._getChildren(c);if(e.length===0){_normalizeContentNode(c);return true;}else{if(e.length>1){return false;}else{if(a.trim(a(c).children().text()).length>0){return false;}else{var f=a(e[0]).children();if(f.length===0||f[0].tagName=="BR"){return true;}return false;}}}},_validateSelectionBeforeDeletion:function(){if(this.ed.selection.isCollapsed()){return false;}var d=this._getParentContentBlockHolder(this.ed.selection.getStart());var c=this._getParentContentBlockHolder(this.ed.selection.getEnd());if(!(this._isNull(d)&&this._isNull(c))&&d!=c){this.ed.windowManager.alert(this.ed.translate("epipersonalizedcontent.invalidselectionondeletewarning"));return true;}return false;},_normalizeContentNode:function(g){var e=a(g);if(e.children().length===0){var d=e.html();if(d.length===0){d='<br mce_bogus="1" />';}e.html("");this.ed.dom.add(g,"p",null,d);}else{for(var c=0;c<g.childNodes.length;c++){var f=g.childNodes[c];if(!this.ed.dom.isBlock(f)&&!(f.nodeType==3&&!f.data.match("."))){a(f).wrap("<p />");}}}},_moveDown:function(h,e){if(e){var f=this._getPCContentBlockHolder(h);if(!f){return false;}var g=a(f).children()[0];if(this._isNull(g)){g=f[0].firstChild;}this._moveSelection(g,true);return true;}else{var c=this.ed.getBody().lastChild;while(c&&c.nodeType==3&&!c.nodeValue.length){c=c.previousSibling;}if(c&&c===h){c=this.ed.dom.add(this.ed.getBody(),"p",null,'<br mce_bogus="1" />');}var d=h.nextSibling||a(h).next().length?a(h).next()[0]:null;if(d){this._moveSelection(d,true);}}},_moveUp:function(f,e){if(e){var c=this._getPCContentBlockHolder(f);var g=a(c).children();if(g.length>0){this._moveSelection(g[g.length-1],false);}else{this._moveSelection(c,false);}}else{var d=a(f).prev()[0];if(typeof d==="undefined"){d=this.ed.dom.create("p",null,'<br _mce_bogus="1" />');f.parentNode.insertBefore(d,f);}this._moveSelection(d,false);return true;}},_block:function(c,d){if(this._selectedPcHeader&&(d.keyCode==13)&&(d.type=="keydown")){return;}if(this._isSpecialKey(d.keyCode)||d.ctrlKey||d.metaKey){return;}return b.dom.Event.cancel(d);},_isSpecialKey:function(c){return(c>32&&c<41)||(c>111&&c<124)||c==46||c==8;},getInfo:function(){return{longname:"EPiServer CMS Personalized Content Plug-in",author:"EPiServer AB",authorurl:"http://www.episerver.com",infourl:"http://www.episerver.com",version:"1.0"};}});b.PluginManager.add("epipersonalizedcontent",b.plugins.epipersonalizedcontent);}(tinymce,epiJQuery));